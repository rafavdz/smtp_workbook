# Session 7: Poisson regression

::: {.callout-warning}
## ðŸš§ Work in Progress

This chapter is a draft and may change significantly.  
Content, examples, and conclusions are not final.
:::

# Introduction

We will now explore count models, which are relevant in transport applications for modelling variables such as the number of trips, number of vehicles, or number of collisions.

The Poisson model is well suited to discrete numeric outcomes ranging from 0 to infinity. Unlike linear regression, Poisson models do not allow negative values. Today, we will examine the number of active travel trips at the household level.


## Preliminaries

For today's session we will need the following packages.

```{r}
# Packages 
library(tidyverse) # For data manipulation
library(gtsummary) # Descriptive statistics
library(performance) # For model fit measures
```


This time, we will need information from trips and households tables only.

```{r}
# Load data
trips <- read_csv('data/Trips.csv')
households <- read_csv('data/Households.csv')
```

We limit the data for the year 2023 only. 

```{r}
# Filter data for the year 2023 only
households <- households %>% filter(survey_year == 2023)
trips <- trips %>% filter(survey_year == 2023)
```


## Dependent variable: Number of active travel trips

We will consider trips that were completed using active travel modes, regardless of the purpose.

```{r}
active_trips <- trips %>%
  filter(mode_class == 'Bike' | mode_class == 'Walk')
```

Next, we count the number of active travel trip for each household.
```{r}
# Summarise trips by household
trips_summary <- active_trips %>% 
  group_by(household_id) %>% 
  summarise(active_trips = n())
```

How many households report active travel trips?

Note that the above does not include households with 0 active mode trips. So, this analysis focuses on the intensity of active travel use e.g. household who have reported at least 1 active travel trip.

Let's look at the distribution, and variace.

```{r}
summary(trips_summary$active_trips)
var(trips_summary$active_trips)
```

Does the variance  approximate the mean?

Remember that this is a key assumption in Poisson regression.

## Independent variables

In addition to the dependent variable (trip count), we need to define the independent variables that we think are related to mode choice to work. For this, we include information from households. So, we supplement the dependent variable information with trips, persons, and households.

```{r}
# Join the tables together
households_main <- trips_summary %>% 
  left_join(households, by = 'household_id')
```

Here, order matters, e.g. we join the number of active trips to all households. So, we exclude all of the households which did not reported active travel trips.

As in our prior lab, we format and label the variables that we will use in the analysis:

```{r}
# HH income labs
income_labs <- c(
  'Under $25,000', '$25,000-$49,999', '$50,000-$74,999', 
  '$75,000-$99,999', '$100,000-$199,999', '$200,000 or more'
)

# Format and create appropriate variables
households_main <- households_main <- households_main %>% 
  mutate(
    children = ifelse(numchildren == '0 children', 'No', 'Yes'),
    hhincome_broad = factor(hhincome_broad, levels = income_labs),
    hhsize_int = as.numeric(str_extract(hhsize, "\\d+")),
    vehicle_broad = case_when(
      vehicle_count == '0 (no vehicles)' ~  '0 (no vehicles)',
      vehicle_count == '1 vehicle' ~  '1 vehicle',
      TRUE ~ '2 or more'
    ),
  )

```

An we keep only the variables of interest for now.
```{r}
# First, select variables of interest
households_main <- households_main %>% 
  select(
    active_trips,
    children, 
    vehicle_broad,
    hhincome_broad,
    hhsize_int,
    numdayscomplete,
    vehicle_broad
  )

# We also remove incomplete observations
households_main <- households_main %>% 
  drop_na()
```



# Descriptive statistics

The distribution of our dependent variable looks as following:
```{r}
households_main %>% 
  ggplot(aes(active_trips)) +
  geom_histogram() +
  labs(
    x = 'Active travel trips',
    y = 'Count'
  )
```

Before moving into the modelling stage, we check the main descriptive statistics. 

```{r results='asis'}
households_main %>% 
  tbl_summary(
    by = children,
    statistic = all_continuous() ~ "{mean} Â± {sd}"
  ) %>% 
  add_overall()
```

Are there noticeable differences between respondent groups?


# Models 

We can fit the Poisson model using a the base-R function `glm()`. We specify the formula, as we have done it with other models, i.e. active trip count is explained by having children and number of motor vehicles. We also need other control variables, e.g. household size, and number of days reported in the survey.


```{r}
# Fit Poisson model
poisson_m1 <- glm(
  formula = active_trips ~ children + vehicle_broad + hhsize_int + numdayscomplete, 
  data = households_main, 
  family = poisson
)
```

Also, we can compute a pseudo-r-squared as a measure of fit.

```{r}
# Measures of fit, e.g. pseudo-square
r2_nagelkerke(poisson_m1)
```

It is very high, why?

We can print the summary of the model in the log count scale:

```{r}
# Results in log count
poisson_m1 %>% 
  tbl_regression() %>% 
  add_glance_table()
```

Here, coefficient interpretations are in terms of the *log count*. However, this is not very intuitive. So, we can exponentiate the coefficients and interpret those as *rate ratio* or *relative risk*.

```{r}
# Results in log count
poisson_m1 %>% 
  tbl_regression(exponentiate = TRUE) %>% 
  add_glance_table()
```

We can see that having children in the household is significant. Specifically, 

> the incidence rate of active travel trips is 2.6 times larger than households without children.

Remember, categorical variables are always interpreted using the category of reference as the baseline.

The household size is entered as a continuous variable. The interpretation is as following:

> For each additional member in the household, the rate of active travel trips is expected to increase by 13%.

As with other multiplicative equations, we can use the following formula to express the changes in percent terms `(1 - coefficient) * 100`.

## Model assumption checks

One of the key assumptions of the Poisson model is that the mean is equal to the variance. Dispersion can occur when the data is more variable than the model assumes. This can yield to estimation problems, such as underestimated errors (e.g. we can conclude something is significant when it is not), or poor model fit.

We can easily test for over dispersion with the `perfomance::` package as following:

```{r}
check_overdispersion(poisson_m1)
```

From this test, the dispersion ratio should be close to 1. From the results we see that this is much larger, and the p-value is lower than 0.05. Thus, we can could that overdispersion is present.

A common alternative, is to use a negative binomial model. This is also useful to model counts and does not assume that the variance is roughly similar to the mean of our count. Thus, this is appropriate when overdispersion is high. For this, we will require the `glm.nb()` function of the `MASS::` package.

```{r}
library(MASS)

# Fit the negative binomial model
negbin_m2 <- glm.nb(
  formula = active_trips ~ children + vehicle_broad + hhsize_int + numdayscomplete, 
  data = households_main
)

# An we print the summary of the model
negbin_m2 %>% 
  tbl_regression(exponentiate = TRUE) %>% 
  add_glance_table()
```

Can you identify key differences compared to the Poisson model? The interpretation of coefficients is very similar.

<br>
<br>
<br>

# Individual activities

Rerun a similar analysis which includes education, and free parking at work to model active travel counts. Think how you would aggregate this information at the household level. Examine the key model assumption using an overdispersion test and use and appropriate model if the key assumption is violated.


<br>
<br>
<br>


