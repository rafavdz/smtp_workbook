# Session 5: Logistic regression Part 2


::: {.callout-warning}
## ðŸš§ Work in Progress

This chapter is a draft and may change significantly.  
Content, examples, and conclusions are not final.
:::


<!-- Outliers: include them from a modelling perspective. Potentially week 4 or 5.  -->

## Preliminaries

For today's session we will need the following packages.

```{r}
# Packages 
library(tidyverse) # For data manipulation
library(gtsummary) # Descriptive statistics
library(performance) # Model checks
```

We will continue to work with the data subset that you created in the last session, which includes information about commuting to work trips at the individual level.

```{r}
persons_main <- readRDS('data/persons_main.RDS')
```

Letâ€™s take a quick look to refresh our understanding of the dataâ€™s contents and structure.

```{r}
glimpse(persons_main)
```

# Logistic regression models

We start by fitting the same logistic regression model that we discussed in Session 4 to identify the relationships between the dependent variable (engaging in active travel to work) and key independent variable (having free parking),  including control variables, such as average trip distance, gender, higher education, presence of children at household, and household income.

```{r}
logit_model1 <- glm(
  active_binary ~ free_parking + avg_distance + gender + higher_education + children + hhincome_broad,
  family = "binomial", 
  data = persons_main
)

```


### Exponentied coefficients: Odds ratio

In the previous session we fitted the logistic regression model, and we made interpretation in the log of the odds scale. However, the log of the odds is not very intuitive or it is hard to communicate for wider audiences. We can exponentiate the coefficients to obtain the odds ratio.

In the previous session, we fitted a logistic regression model and interpreted the coefficients on the **log-odds scale**. However, the log of the odds is not very intuitive or it is hard to communicate for wider audiences. We can exponentiate the coefficients to obtain the odds ratio. If the logit model is:

$$
\log\left(\frac{p}{1-p}\right) = \beta_0 + \beta_1 X
$$

then exponentiating both sides gives:

$$
\frac{p}{1-p} = e^{\beta_0 + \beta_1 X} = e^{\beta_0} \cdot e^{\beta_1 X}
$$


The exponentiation reverses the logarithm, transforming coefficients from the log-odds scale back to the odds scale. Specifically, $e^{\beta_1}$ represents the **odds ratio (OR)**:

$$
\text{OR} = e^{\beta_1}
$$

Thus, for a one-unit increase in $X$, the odds of the outcome are multiplied by $e^{\beta_1}$. Specifically:

* If $\beta_1 > 0$, then $e^{\beta_1} > 1$, meaning the odds **increase**
* If $\beta_1 < 0$, then $e^{\beta_1} < 1$, meaning the odds **decrease**
* If $\beta_1 = 0$, then $e^{\beta_1} = 1$, meaning the odds remain **unchanged**

For example, if $\beta_1 = 0.5$, then $e^{0.5} \approx 1.65$, meaning the odds increase by 65% for each one-unit increase in $X$.

#### Odds ratio in our example

Let's exponentiate the results of our logistic regression model!

```{r}
logit_model1 %>% 
  tbl_regression(exponentiate = TRUE) %>% 
  add_glance_table()
```

Here, the interpretations changes compare to the log of the odds. For example, the odds ratio of using active transport modes are about 50% lower for people with free parking at work compared to those without free parking. Note that we make interpretations in relation to 1. Specifically, a value lower than one implies a decrease in the odds of using active transport modes. Generally we use the following formula to express the changes in percent terms `(1 - coefficient) * 100`.

For continuous variables the interpretation is as follows: Every additional mile to work is associated with a 20% decrease in the odds ratio of using active transport modes.

Note that we are talking either about the log of the odds or the odds ratio, not the probability.

::: {.callout-question title="Reflection"}
Can you provide the interpretation for other coefficients?
:::

## Model checks 


The following function provides a the McFadden pseudo-r-squared measure.

```{r}
r2_mcfadden(logit_model1)
```

We can also check the percentage of correct predictions.

```{r}
performance_pcp(logit_model1)
```

There are generally three assumptions for the logit model: 
1. independence of observations; 
2. linearity; and 
3. no perfect multicollinearity.

We can check for collinearity using the variance of inflation factor (VIF).

```{r}
check_collinearity(logit_model1)
```

We can check linearity examining the relationship between each continuous predictor and log-odds of the predicted probabilities. In our model, we only have one continuous variable. We can check the linearity of our model as following:

```{r out.width="95%"}

# Source Harrys J.K. (2019)

# Compute a variable of the log-odds of the predicted values
logit_pred <- log(logit_model1$fitted.values / (1- logit_model1$fitted.values))

# Create a small data frame with the log-odds and the distance predictor
linearity_data1 <- 
  data.frame(
    logit_pred, 
    avg_distance = logit_model1$model$avg_distance
)

# Plot
linearity_data1 %>% 
  ggplot(aes(avg_distance, logit_pred)) +
  geom_point() +
  geom_smooth(method = 'loess', aes(col = 'Loess curve'), se = FALSE) +
  geom_smooth(method = 'lm', aes(col = 'Linear fit'), se = FALSE) +
  labs(
    x = "Avg. distance to work (in miles)",
    y= "Log-odds of active travel \npredicted probability"
  )

```

We should check whether the predictions are equally accurate along the range of values of the predictor.

Independence is related to the structure and collection methods of data. To what extend does our model and data meet the independence assumption?

# Individual activities

Re-run a similar analysis, but focus on public transport use (labelled as 'transit' in the data). Specifically, the dependent variable will be whether people used public transport in at least one of their trips for a purpose of your choice other than work.

In this analysis, the key predictor will be employers' subsidies for public transport, such as free passes or fares. Hint: this information is available in the 'commute_subsidy_1' variable of the 'persons' table. You can keep similar control variables and optionally check how parking regulations or policies are related to the use of public transport.

## Reference

Harrys J.K. 2019, Statistics With R: Solving Problems Using Real-World Data. SAGE Publications. (p. 651)